<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Dashboard - Financial Chatbot</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script>
    async function fetchChats(customerId, sessionId) {
      try {
        const response = await fetch('/agent/get_last_chats', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ customer_id: customerId })
        });
        
        if (!response.ok) throw new Error('Failed to fetch chats');
        
        const data = await response.json();
        const chatBox = document.getElementById(`chat-${sessionId}`);
        
        // Show the chat box
        chatBox.classList.remove('hidden');
        
        // Display chat history with color coding
        chatBox.innerHTML = data.chats.map(chat => `
          <div class="mb-3 flex ${chat.sender === 'user' ? 'justify-start' : 'justify-end'}">
            <div class="max-w-xs px-4 py-2 rounded-lg ${
              chat.sender === 'user' ? 'bg-gray-100 border border-gray-200' : 
              chat.sender === 'agent' ? 'bg-indigo-100 border border-indigo-200' : 
              'bg-blue-50 border border-blue-200'
            }">
              <p class="text-sm font-medium ${
                chat.sender === 'agent' ? 'text-indigo-700' : 
                chat.sender === 'bot' ? 'text-blue-700' : 'text-gray-700'
              }">${
                chat.sender === 'user' ? 'Customer' : 
                chat.sender === 'agent' ? 'Agent' : 'Bot'
              }</p>
              <p class="text-md my-1">${chat.message_text}</p>
              <p class="text-xs text-gray-500">${formatTimestamp(chat.timestamp)}</p>
            </div>
          </div>
        `).join('');
        
        // Add button to open full chat interface
        chatBox.innerHTML += `
          <div class="mt-4 flex justify-center space-x-4">
            <button 
              onclick="openFullChatInterface('${customerId}', '${sessionId}')" 
              class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
              Join Live Chat Session
            </button>
          </div>
        `;
      } catch (error) {
        console.error('Error fetching chats:', error);
        showNotification('Error loading conversation history', 'error');
      }
    }

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString();
    }

    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `fixed top-4 right-4 px-4 py-2 rounded shadow-lg ${
        type === 'error' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'
      }`;
      notification.style.display = 'block';
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }

    async function updateTaskStatus(taskId, status) {
      try {
        const response = await fetch('/agent/update_task_status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            task_id: taskId,
            status: status 
          })
        });
        
        if (!response.ok) throw new Error('Failed to update task status');
        
        showNotification(`Task marked as ${status}`, 'info');
        
        // Update UI to reflect the new status
        const statusBadge = document.getElementById(`status-${taskId}`);
        if (statusBadge) {
          statusBadge.className = `px-2 py-1 text-xs font-medium rounded ${
            status === 'resolved' ? 'bg-green-100 text-green-800' : 
            status === 'in_process' ? 'bg-yellow-100 text-yellow-800' : 
            'bg-gray-100 text-gray-800'
          }`;
          statusBadge.textContent = status.replace('_', ' ').toUpperCase();
        }
      } catch (error) {
        console.error('Error updating task status:', error);
        showNotification('Failed to update task status', 'error');
      }
    }

    async function loadDashboard() {
      try {
        document.getElementById('loading-indicator').style.display = 'flex';
        const res = await fetch('/agent/unresolved_sessions');
        
        if (!res.ok) throw new Error('Failed to load sessions');
        
        const data = await res.json();
        const container = document.getElementById('dashboard');
        
        if (data.sessions.length === 0) {
          container.innerHTML = '<div class="bg-white p-6 rounded-lg shadow-md text-center">No unresolved sessions found.</div>';
          return;
        }
        
        container.innerHTML = data.sessions.map(session => `
          <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300">
            <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
              <div class="space-y-2">
                <div class="flex items-center justify-between">
                  <div class="flex items-center">
                    <span class="font-semibold text-gray-700 w-32">Customer ID:</span>
                    <span>${session.customer_id}</span>
                  </div>
                  <div id="status-${session.task_id || session.document_id}" class="px-2 py-1 text-xs font-medium rounded ${
                    session.status === 'resolved' ? 'bg-green-100 text-green-800' : 
                    session.status === 'in_process' ? 'bg-yellow-100 text-yellow-800' : 
                    'bg-gray-100 text-gray-800'
                  }">
                    ${session.status ? session.status.replace('_', ' ').toUpperCase() : 'PENDING'}
                  </div>
                </div>
                <div class="flex items-center">
                  <span class="font-semibold text-gray-700 w-32">Phone:</span>
                  <span>${session.phone_number || 'Not provided'}</span>
                </div>
                <div class="flex items-center">
                  <span class="font-semibold text-gray-700 w-32">Created:</span>
                  <span>${formatTimestamp(session.created_at)}</span>
                </div>
                <div class="flex items-start">
                  <span class="font-semibold text-gray-700 w-32">Summary:</span>
                  <span class="text-sm">${session.document_text}</span>
                </div>
              </div>
              <div class="flex flex-col space-y-2">
                <button onclick="fetchChats('${session.customer_id}', '${session.document_id}')" 
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                  View Conversation
                </button>
                <div class="flex space-x-2">
                  <button onclick="updateTaskStatus('${session.task_id || session.document_id}', 'in_process')" 
                          class="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600 transition-colors duration-300">
                    In Process
                  </button>
                  <button onclick="updateTaskStatus('${session.task_id || session.document_id}', 'resolved')" 
                          class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors duration-300">
                    Resolved
                  </button>
                </div>
              </div>
            </div>
            <div id="chat-${session.document_id}" class="mt-4 bg-gray-50 p-4 rounded-md border border-gray-200 text-sm max-h-96 overflow-y-auto hidden"></div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('dashboard').innerHTML = 
          '<div class="bg-red-50 p-4 rounded-lg border border-red-200 text-red-700">Failed to load unresolved sessions. Please try again later.</div>';
      } finally {
        document.getElementById('loading-indicator').style.display = 'none';
      }
    }

    function openFullChatInterface(customerId, sessionId) {
      // Store the customer and session information in localStorage
      localStorage.setItem('agent_mode', 'true');
      localStorage.setItem('customer_id', customerId);
      localStorage.setItem('session_id', sessionId);
      
      // Open the chat interface in a new window
      window.open('/agent-chat-interface', '_blank', 'width=500,height=700');
    }

    window.onload = loadDashboard;
  </script>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen">
  <div id="notification" style="display: none;" class="fixed top-4 right-4 px-4 py-2 rounded shadow-lg"></div>
  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">Agent Dashboard</h1>
        <div class="text-sm text-gray-600">Financial Support System</div>
      </div>
    </div>
  </header>
  
  <main class="container mx-auto px-6 py-8">
    <div class="mb-6 flex justify-between items-center">
      <h2 class="text-xl font-semibold text-gray-700">Unresolved Customer Sessions</h2>
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 rounded-full bg-gray-300"></div>
          <span class="text-sm text-gray-600">Pending</span>
        </div>
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
          <span class="text-sm text-gray-600">In Process</span>
        </div>
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 rounded-full bg-green-500"></div>
          <span class="text-sm text-gray-600">Resolved</span>
        </div>
        <button onclick="loadDashboard()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm transition-colors duration-300">
          Refresh
        </button>
      </div>
    </div>
    
    <div id="loading-indicator" class="flex justify-center items-center py-12">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-700"></div>
    </div>
    
    <div id="dashboard" class="space-y-6"></div>
  </main>
  
  <footer class="bg-gray-800 text-white py-4 mt-auto">
    <div class="container mx-auto px-6 text-center text-sm">
      <p>&copy; 2023 Financial Chatbot System. All rights reserved.</p>
    </div>
  </footer>
</body>
</html>
