<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Financial Chatbot</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #121212;
    color: #eee;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; height: 100vh;
  }
  #chat-box {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: #222;
  }
  p.bot {
    background: #444;
    padding: 0.6rem 1rem;
    border-radius: 12px;
    max-width: 70%;
    margin: 0.3rem 0;
  }
  p.user {
    background: #0084ff;
    padding: 0.6rem 1rem;
    border-radius: 12px;
    color: #fff;
    max-width: 70%;
    margin: 0.3rem 0;
    align-self: flex-end;
  }
  p.bot strong {
    color: #ffe082;
  }
  p.bot ul {
    list-style-type: disc;
    margin-left: 1.5rem;
    padding-left: 0;
  }
  p.bot li {
    margin-bottom: 0.3rem;
  }
  #input-area {
    display: flex;
    background: #181818;
    padding: 0.5rem;
  }
  #user-input {
    flex: 1;
    padding: 0.8rem;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    background: #333;
    color: #eee;
    resize: none;
    overflow: hidden;
  }
  #user-input:focus {
    outline: none;
  }
  button.option-button {
    margin: 0.2rem;
    padding: 0.4rem 1rem;
    background: #333;
    border: none;
    border-radius: 6px;
    color: #eee;
    cursor: pointer;
    font-weight: 600;
  }
  button.option-button:hover {
    background: #555;
  }
  .options-container, .feedback-container {
    margin: 1rem 0;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  button.feedback-button {
    padding: 0.5rem 1.2rem;
    font-weight: 600;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    background-color: #28a745;
    color: white;
  }
  button.feedback-button.negative {
    background-color: #dc3545;
  }
  #loader {
    display: none;
    text-align: center;
    padding: 0.5rem;
    color: #aaa;
  }
  #loader.show {
    display: block;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div id="chat-box"></div>
  <div id="loader">‚è≥ Loading...</div>
  <div id="input-area">
    <textarea id="user-input" rows="1" placeholder="Type your message and press Enter..."></textarea>
  </div>

<script>
  // --- START OF CORRECTED SCRIPT ---

  // 'stage' now controls the conversation flow:
  // 0 = Waiting for initial query (text or button)
  // 1 = Waiting for Account ID
  // 2 = Waiting for OTP
  // 3 = Authenticated and ready to chat
  let stage = 0;
  let chatHistory = [];
  let pendingMessage = ""; // To store the user's first query during auth

  window.onload = function () {
    const userInput = document.getElementById("user-input");
    userInput.addEventListener("input", function() {
        this.style.height = "auto";
        this.style.height = (this.scrollHeight) + "px";
    });

    setTimeout(() => {
      addMessage("Hello! I am your financial assistant. You can ask me about your EMI, account balance, or loan details. You can also select an option below.", 'bot');
      showOptions();
    }, 1000);

    userInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleUserInput();
      }
    });
  };

  function showOptions() {
    const options = [
      { text: "My EMI", value: "emi" },
      { text: "My Account Balance", value: "balance" },
      { text: "My Loan Amount", value: "loan" }
    ];
    const chatBox = document.getElementById("chat-box");
    const container = document.createElement("div");
    container.className = "options-container";

    options.forEach(opt => {
      const btn = document.createElement("button");
      btn.className = "option-button";
      btn.textContent = opt.text;
      btn.onclick = () => handleOption(opt.value, opt.text);
      container.appendChild(btn);
    });

    chatBox.appendChild(container);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function handleOption(value, label) {
    // Treat the button click like a typed message
    pendingMessage = value; // Store the intent value directly
    addMessage(label, 'user');
    removeOptions();
    addMessage("Understood. To proceed, please enter your Account ID:", 'bot');
    stage = 1;
  }

  function removeOptions() {
    const opts = document.querySelector(".options-container");
    if (opts) opts.remove();
  }

  async function handleUserInput() {
    const inputField = document.getElementById("user-input");
    const input = inputField.value.trim();
    if (!input) return;
    addMessage(input, 'user');
    inputField.value = "";
    inputField.style.height = "auto";

    if (stage === 0) {
      // Stage 0: User types their first query
      pendingMessage = input; // Store the query
      removeOptions();
      addMessage("Understood. To proceed, please enter your Account ID:", 'bot');
      stage = 1;

    } else if (stage === 1) {
      // Stage 1: User enters Account ID
      const accountId = input;
      showLoader(true);
      try {
        const response = await fetch("/send_otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ account_id: accountId })
        });
        const data = await response.json();
        addMessage(data.message || "An unknown error occurred.", 'bot');
        if (response.ok) {
          stage = 2; // Move to OTP stage only on success
        }
      } catch (err) {
        console.error("Error sending OTP:", err);
        addMessage("A network error occurred while sending the OTP.", 'bot');
      } finally {
        showLoader(false);
      }

    } else if (stage === 2) {
      // Stage 2: User enters OTP
      const otp = input;
      showLoader(true);
      try {
        const response = await fetch("/verify_otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ otp: otp })
        });
        const data = await response.json();
        addMessage(data.message || "An unknown error occurred.", 'bot');
        if (response.ok) {
          stage = 3; // Authentication successful
          // FIX: Only send the original query (pendingMessage) to /chat, not "Fetching your information..."
          showLoader(true);
          await processChat(pendingMessage);
          showLoader(false);
        }
      } catch (err) {
        console.error("Error verifying OTP:", err);
        addMessage("A network error occurred while verifying the OTP.", 'bot');
      } finally {
        showLoader(false);
      }

    } else if (stage === 3) {
      // Stage 3: Authenticated user sends a follow-up message
      await processChat(input);
    }
  }

  // This is the single, unified function to talk to the backend's /chat endpoint
  async function processChat(message) {
    showLoader(true);
    try {
      // Make sure we're using proper object structure for chat history
      const formattedChatHistory = chatHistory.map(entry => ({
        sender: entry.sender,
        content: entry.content
      }));
      
      const response = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: message,
          chat_history: formattedChatHistory
        })
      });
      const data = await response.json();
      if (response.ok) {
        addMessage(data.reply, 'bot', true);
        showFeedbackButtons();
      } else {
        addMessage(data.message || "Sorry, I couldn't fetch that information.", 'bot');
        resetToInitialState();
      }
    } catch (err) {
      console.error("Error processing chat:", err);
      addMessage("A network error occurred while fetching your information.", 'bot');
      resetToInitialState();
    } finally {
      showLoader(false);
    }
  }

  function addMessage(msg, sender, isMarkdown = false) {
    const chatBox = document.getElementById("chat-box");
    const message = document.createElement("p");
    message.className = sender;

    if (isMarkdown && sender === 'bot') {
      message.innerHTML = marked.parse(msg);
    } else {
      message.textContent = msg;
    }
    chatBox.appendChild(message);
    chatBox.scrollTop = chatBox.scrollHeight;

    chatHistory.push({ sender: sender, content: msg });
  }

  function showLoader(show) {
    const loader = document.getElementById("loader");
    loader.style.display = show ? "block" : "none";
  }

  function showFeedbackButtons() {
    // Remove any existing feedback buttons before adding new ones
    document.querySelector(".feedback-container")?.remove();
    
    const chatBox = document.getElementById("chat-box");
    const feedbackContainer = document.createElement("div");
    feedbackContainer.className = "feedback-container";

    const positiveBtn = document.createElement("button");
    positiveBtn.className = "feedback-button";
    positiveBtn.textContent = "üëç Useful";
    positiveBtn.onclick = () => sendFeedback(true);

    const negativeBtn = document.createElement("button");
    negativeBtn.className = "feedback-button negative";
    negativeBtn.textContent = "üëé Not Useful";
    negativeBtn.onclick = () => sendFeedback(false);

    feedbackContainer.appendChild(positiveBtn);
    feedbackContainer.appendChild(negativeBtn);
    chatBox.appendChild(feedbackContainer);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  async function sendFeedback(isUseful) {
    document.querySelector(".feedback-container")?.remove();
    addMessage("Thank you for your feedback!", 'bot');

    if (!isUseful) {
      addMessage("I've logged this conversation for review by a human agent to help improve my responses.", 'bot');
      try {
        // NOTE: Ensure the /summarize_chat route is active (uncommented) in your app.py
        await fetch("/summarize_chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ chat_history: chatHistory }),
        });
      } catch (err) {
        console.error("Error sending summary:", err);
      }
    }
    resetToInitialState();
  }

  function resetToInitialState() {
     setTimeout(() => {
        addMessage("Is there anything else I can help you with?", 'bot');
        stage = 3; // Keep user authenticated for the next query
        pendingMessage = "";
        showOptions();
    }, 1500);
  }

  // --- END OF CORRECTED SCRIPT ---
</script>
</body>
</html>